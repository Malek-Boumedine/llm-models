FROM --platform=linux/amd64 python:3.11-slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates build-essential gcc python3-dev \
    && rm -rf /var/lib/apt/lists/*

ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh
ENV PATH="/root/.local/bin:$PATH"

WORKDIR /app

COPY pyproject.toml uv.lock ./
RUN uv venv && uv sync

ENV HF_HOME=/root/.cache/huggingface
RUN pip install sentence-transformers 
RUN python -c "from sentence_transformers import SentenceTransformer; print('Téléchargement du modèle BAAI/bge-m3...'); model = SentenceTransformer('BAAI/bge-m3'); print('Modèle téléchargé avec succès')"

COPY src ./src
COPY .env.chainlit ./.env
COPY create_admin.py ./

RUN mkdir -p logs

ENV CHAINLIT_HOST=0.0.0.0
ENV CHAINLIT_PORT=8000
EXPOSE 8000

CMD ["uv", "run", "chainlit", "run", "src/chainlit_app/main.py", "--host", "0.0.0.0", "--port", "8000"]
